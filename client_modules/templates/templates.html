

<script template="text" type="text/x-ejs-template">
    <% if (text) { %>
        <p class="text">
            <%- text.replace(/\n/g, '<br>') %>
        </p>
    <% }; %>
</script>

<script template="visual" type="text/x-ejs-template">
    <% const c = (w, d) => '/file?' + (d? 'd=1&' : '') + 'id=' + w.id %>
    <% const total = files.image.length + files.video.length %>
    
    <% if (total > 1) { %>
        <% let nlarge = total % 3; %>
        <% if (nlarge == 4) nlarge = 1; %>
        <% let i = 0 %>
        
        <div class="visual" inspect-group>
            <% while (i < total) { %>
                <% let isimg = i < files.image.length %>
                <% let cls = (i < nlarge? 'large' : 'small') + (isimg? '': ' video') %>

                <div class="tile <%= cls %>" >

                    <% if (isimg) { %>
                        <img src="<%= c(files.image[i]) %>">
                    <% } else { %>
                        <video src="<%= c(files.video[i - imgc]) %>", preload="metacont">
                    <% }; i++; %>

                </div>

            <% } %>
        </div>
    <% } else if (files.image.length) { %>
        <img src="<%= c(files.image[0]) %>" class="semi-image" inspect>
    <% } else if (files.video.length) { %>
        <video controls class="semi-video">
            source(src="<%= files.video[0] %>")
        </video>
    <% } %>
</script>

<script template="audio" type="text/x-ejs-template">
    <% if (audio.length) { %>
        <div class="audio">
            <% audio.forEach(a => { %>
                <audio controls>
                    source(src="/file?id=<%= a.id %>")
                </audio>
            <% }) %>
        </div>
    <% } %>
</script>

<script template="other" type="text/x-ejs-template">
    <% if (other.length) { %>
        <ul class="other">
            <% other.forEach(o => { %>
                <li class="finite">
                    <a href="/file?d=1&id=<%= o.id %>" class="clean">
                        <%= o.name %>
                    </a>
                </li>
            <% }) %>
        </ul>
    <% } %>
</script>

<script template="html" type="text/x-ejs-template">
    <% if (html) { %>
        <div class="html block styled-scroll">
            <iframe scrolling="no"></iframe>
        </div>
    <% } %>
</script>

<script template="msg-content" type="text/x-ejs-template">
    <div class="content">
        <%- templateManager.apply("visual", {files: files}) %>
        <%- templateManager.apply("audio", {audio: files.audio}) %>
        <%- templateManager.apply("other", {other: files.other}) %>
        <%- templateManager.apply("text", {text: text}) %>
    </div>
</script>

<script template="post-content" type="text/x-ejs-template">
    <div class="content">
        <%- templateManager.apply("text", {text: text}) %>
        <%- templateManager.apply("audio", {audio: files.audio}) %>
        <%- templateManager.apply("visual", {files: files}) %>
        <%- templateManager.apply("other", {other: files.other}) %>
        <%- templateManager.apply("html", {html: html}) %>
    </div>
</script>

<!-- <%- templateManager.apply("html", {html: html}) %> -->

<script template="system-message" type="text/x-ejs-template">
    <span class="system-message"><%= text %></span>
</script>

<script template="user-message" type="text/x-ejs-template">
    <% let cls = (data.minor? 'minor' : '') + ' ' + (myid == data.sender_id? 'mine' : '') %>
    <div class="user-message block <%= cls %>">
        <% if (!data.minor) { %>
            <div class="top-bar">
                <a href="/user?tag=<%= data.sender_tag %>" class="finite clean name">
                    <%= data.sender_name %>
                </a>
                <span class="date">
                    <%= utils.formatTime(data.datetime) %>
                </span>
            </div>
        <% } %>
        <%- templateManager.apply("msg-content", data) %>
    </div>
</script>

<script template="universal-message" type="text/x-ejs-template">
    <div class="message-wrapper" msg-id="<%= data.id %>">
        <% if (data.dateLabel) { %>
            <%- templateManager.apply("system-message", {text: utils.getLocalizedDateLabel(data.datetime, true)}) %>
        <% } %> 
        <% if (data.sender_id !== null && data.sender_id !== undefined) { %>
            <%- templateManager.apply("user-message", {data: data, myid: myid}) %>
        <% } else { %>
            <%- templateManager.apply("system-message", {text: data.text}) %>
        <% } %>
    </div>
</script>

<script template="post" type="text/x-ejs-template">
    <div class="post block" id="post<%= data.id %>">
        <div class="top-bar">
            <% if (!hide_author) { %>
                <span class="prefix">–ù–æ–≤–æ—Å—Ç—å –æ—Ç</span>
                <a href="/user?tag=<%= data.author_tag %>" class="finite clean name">
                    <%= data.author_name %>
                </a>
            <% } %>
            <span class="datetime">
                <%= utils.getPostDatetimeLabel(data.datetime, true) %>
            </span>
        </div>
        <% if (data.title) { %>
            <span class="title">
                <%= data.title%>
            </span>
        <% } %>
        <%- templateManager.createHTML("post-content", data) %>
        <div class="actions">
            <button class="button like">üëç</button>
            <button class="button dislike">üëé</button>
            <select class="button donate">
                <option style="display:none;" value="default" selected>–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</option>
                <option value="10">10EBL</option>
                <option value="25">25 EBL</option>
                <option value="50">50 EBL</option>
                <option value="100">100 EBL</option>
                <option value="cancel">–û—Ç–º–µ–Ω–∞</option>
            </select>
        </div>
    </div>
</script>

<script template="html-srcdoc" type="text/x-ejs-template">
    <html><body style="margin:0;padding:0;"><%- html %></body></html>
</script>