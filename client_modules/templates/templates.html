

<script template="text" type="text/x-ejs-template">
    <% if (text) { %>
        <p class="text">
            <%- text.replace(/\n/g, '<br>') %>
        </p>
    <% }; %>
</script>

<script template="visual" type="text/x-ejs-template">
    <% const c = (w, d) => '/file?' + (d? 'd=1&' : '') + 'id=' + w.id %>
    <% const total = files.image.length + files.video.length %>
    
    <% if (total > 1) { %>
        <% let nlarge = total % 3; %>
        <% if (nlarge == 1) nlarge = 4; %>
        <% let i = 0 %>
        
        <div class="visual" inspect-group>
            <% while (i < total) { %>
                <% let isimg = i < files.image.length %>
                <% let cls = (i < nlarge? 'large' : 'small') + (isimg? '': ' video') %>

                <div class="tile <%= cls %>" >

                    <% if (isimg) { %>
                        <img src="<%= c(files.image[i]) %>">
                    <% } else { %>
                        <video src="<%= c(files.video[i - imgc]) %>", preload="metacont">
                    <% }; i++; %>

                </div>

            <% } %>
        </div>
    <% } else if (files.image.length) { %>
        <img src="<%= c(files.image[0]) %>" class="semi-image" inspect>
    <% } else if (files.video.length) { %>
        <video controls class="semi-video" preload="metadata">
            <source src="/file?id=<%= files.video[0].id %>#t=0.001">
        </video>
    <% } %>
</script>

<script template="audio" type="text/x-ejs-template">
    <% if (audio.length) { %>
        <div class="audio">
            <% audio.forEach(a => { %>
                <audio controls preload="metadata">
                    <source src="/file?id=<%= a.id %>">
                </audio>
            <% }) %>
        </div>
    <% } %>
</script>

<script template="other" type="text/x-ejs-template">
    <% if (other.length) { %>
        <ul class="other">
            <% other.forEach(o => { %>
                <li class="finite">
                    <a href="/file?d=1&id=<%= o.id %>" class="clean">
                        <%= o.name %>
                    </a>
                </li>
            <% }) %>
        </ul>
    <% } %>
</script>

<script template="html" type="text/x-ejs-template">
    <% if (html) { %>
        <div class="html block styled-scroll">
            <iframe scrolling="no"></iframe>
        </div>
    <% } %>
</script>

<script template="post-content" type="text/x-ejs-template">
    <div class="content">
        <%- templateManager.apply("text", {text: text}) %>
        <%- templateManager.apply("audio", {audio: files.audio}) %>
        <%- templateManager.apply("visual", {files: files}) %>
        <%- templateManager.apply("other", {other: files.other}) %>
        <%- templateManager.apply("html", {html: html}) %>
    </div>
</script>

<!-- <%- templateManager.apply("html", {html: html}) %> -->

<script template="system-message" type="text/x-ejs-template">
    <span class="system-message"><%= text %></span>
</script>

<script template="standard-message" type="text/x-ejs-template">
    <% let cls = (data.minor? 'minor' : '') + ' ' + (myid == data.sender_id? 'mine' : '') %>

    <div class="user-message <%= cls %>">
        <img class="avatar" src="/getuseravatar?id=<%= data.sender_id %>">
        <div class="block content-block">
            <a href="/user?tag=<%= data.sender_tag %>" class="finite clean name">
                <%= data.sender_name %>
            </a>
            
            <% if (data.type == 'default') { %>
            <%- templateManager.apply("visual", {files: data.files}) %>
            <%- templateManager.apply("audio", {audio: data.files.audio}) %>
            <%- templateManager.apply("other", {other: data.files.other}) %>
            <div class="bottom" style="min-width:150px;">
                <p class="text">
                    <%- data.content.replace(/\n/g, '<br>') %>
                </p>
                <span class="time">
                    <%= utils.formatTime(data.datetime) %>
                </span>
            </div>
            <% } else if (data.type == 'sticker') { %>
                <img src="<%=data.content%>" style="display:block;margin:0;height:80px">
                <div class="bottom">
                    <span class="time">
                        <%= utils.formatTime(data.datetime) %>
                    </span>
                </div>
            <% } %>


        </div>
    </div>
</script>

<script template="universal-message" type="text/x-ejs-template">
    <div class="message-wrapper" msg-id="<%= data.id %>">
        <% if (data.dateLabel) { %>
            <div class="date-label">
                <%- templateManager.apply("system-message", {text: utils.getLocalizedDateLabel(data.datetime, true)}) %>
            </div>
        <% } %>

        <% if (data.sender_id !== null && data.sender_id !== undefined) { %>
            <%- templateManager.apply("standard-message", {data: data, myid: myid}) %>
        <% } else { %>
            <%- templateManager.apply("system-message", {text: data.text}) %>
        <% } %>
    </div>
</script>

<script template="html-srcdoc" type="text/x-ejs-template">
    <html><body style="margin:0;padding:0;"><%- html %></body></html>
</script>