select m.id, m.local_id, m.sender_id, m.text, m.datetime, 
 u.name as sender_name, u.tag as sender_tag, f.id as file_id, f.name as file_name, f.mimetype 
 as file_mimetype from 
 (select * from message where chat_id={chatid} and local_id <= {start} order by id desc limit {count})
 m left join file f on m.bundle_id = f.bundle_id left 
 join user u on m.sender_id = u.id order by id desc